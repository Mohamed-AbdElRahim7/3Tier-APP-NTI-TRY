pipeline {
    agent any

    environment {
        TF_IMAGE = "hashicorp/terraform:1.6.6"
        TF_WORKDIR = "terraform"
    }

    stages {
        stage('Terraform Destroy') {
            steps {
                dir("${TF_WORKDIR}") {
                    withCredentials([
                        string(credentialsId: 'AWS_ACCESS_KEY_ID', variable: 'AWS_ACCESS_KEY_ID'),
                        string(credentialsId: 'AWS_SECRET_ACCESS_KEY', variable: 'AWS_SECRET_ACCESS_KEY')
                    ]) {
                        sh '''
                            docker run --rm \
                            -v $PWD:/workspace \
                            -w /workspace \
                            -e AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID \
                            -e AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY \
                            ${TF_IMAGE} init

                            docker run --rm \
                            -v $PWD:/workspace \
                            -w /workspace \
                            -e AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID \
                            -e AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY \
                            ${TF_IMAGE} destroy -auto-approve
                        '''
                    }
                }
            }
        }
    }
}
